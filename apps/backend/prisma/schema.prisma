// ============================================
// PRISMA SCHEMA - KLY SAV Platform
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  CUSTOMER
  AGENT
  SUPERVISOR
  ADMIN
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_CUSTOMER
  RESOLVED
  CLOSED
  ESCALATED
  REOPENED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum IssueType {
  TECHNICAL
  DELIVERY
  BILLING
  OTHER
}

enum AttachmentContext {
  TICKET
  MESSAGE
}

enum TicketAction {
  CREATED
  UPDATED
  ASSIGNED
  UNASSIGNED
  AUTO_ASSIGNED
  TRANSFER_ACCEPTED
  TRANSFER_DECLINED
  STATUS_CHANGED
  PRIORITY_CHANGED
  ESCALATED
  REOPENED
  CLOSED
  NOTE_ADDED
}

enum NotificationType {
  MESSAGE
  MENTION
  TICKET_UPDATE
  SLA_WARNING
  SLA_BREACH
}

// ============================================
// MODEL: USER
// ============================================

model User {
  id          String   @id @default(cuid())
  email       String?  @unique
  phone       String?
  displayName String
  role        UserRole @default(CUSTOMER)
  isActive    Boolean  @default(true)

  passwordHash       String?
  mustChangePassword Boolean  @default(false)  // Force changement mdp a la prochaine connexion
  avatarUrl          String?  // URL de l'avatar (Google, etc.)

  // SAGE 100 - Code client (pour les customers)
  customerCode String?  @unique  // Code compte client SAGE (ex: COCO001)

  lastSeenAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations Ticket
  tickets         Ticket[] @relation("CustomerTickets")
  assignedTickets Ticket[] @relation("AssignedTickets")

  // Relations Chat
  messages     ChatMessage[]
  mentionsIn   ChatMessage[] @relation("MessageMentions")

  // Notifications
  notifications Notification[]

  // Historique
  historyActor TicketHistory[] @relation("HistoryActor")

  // Canned responses usage
  cannedResponsesUsed CannedResponseUse[]

  // Automation rules created by this user
  automationRulesCreated AutomationRule[] @relation("AutomationCreator")

  // Social accounts (Google, Microsoft, etc.)
  socialAccounts SocialAccount[]

  @@index([email])
  @@index([role])
  @@index([customerCode])
}

// ============================================
// MODEL: SOCIAL ACCOUNT (OAuth providers)
// ============================================

enum OAuthProvider {
  GOOGLE
  MICROSOFT
  APPLE
}

model SocialAccount {
  id              String        @id @default(cuid())
  provider        OAuthProvider
  providerUserId  String        // ID unique du provider (Google sub, etc.)

  // Infos du provider
  email           String?
  name            String?
  avatarUrl       String?

  // Tokens (optionnel, pour refresh)
  accessToken     String?
  refreshToken    String?
  tokenExpiresAt  DateTime?

  // Relation utilisateur
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([provider, providerUserId])
  @@index([userId])
  @@index([provider, email])
}

// ============================================
// MODEL: ORDER (Compatible SAGE 100)
// ============================================

model Order {
  id            String   @id @default(cuid())

  // Références SAGE 100
  orderNumber   String   @unique  // BC - Bon de Commande
  blNumber      String?  @unique  // BL - Bon de Livraison
  faNumber      String?  @unique  // FA - Facture

  // Client
  customerCode  String?           // Code compte client SAGE (ex: COCO001)
  customerEmail String?
  customerPhone String?
  customerName  String?
  companyName   String?

  // Métadonnées SAGE
  sageRef       String?           // Référence interne SAGE
  orderDate     DateTime?         // Date de commande
  deliveryDate  DateTime?         // Date de livraison prévue
  totalAmount   Decimal?          // Montant total HT
  status        String?           // Statut SAGE (en cours, livrée, facturée)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  tickets Ticket[]
  lines   OrderLine[]

  @@index([orderNumber])
  @@index([blNumber])
  @@index([faNumber])
  @@index([customerCode])
  @@index([customerEmail])
  @@index([sageRef])
}

// ============================================
// MODEL: ORDER LINE (Lignes de commande SAGE)
// ============================================

model OrderLine {
  id            String   @id @default(cuid())

  // Relation avec la commande
  orderId       String
  order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Données SAGE
  lineNumber    Int               // DL_Ligne - Numéro de ligne
  productCode   String?           // AR_Ref - Référence article
  productName   String            // DL_Design - Désignation
  quantity      Decimal           // DL_Qte - Quantité
  unitPrice     Decimal?          // DL_PrixUnitaire - Prix unitaire HT
  totalHT       Decimal?          // DL_MontantHT - Montant total HT

  // Infos article supplémentaires
  unit          String?           // Unité de mesure
  discount      Decimal?          // Remise en %

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([orderId, lineNumber])
  @@index([orderId])
  @@index([productCode])
}

// ============================================
// MODEL: TICKET
// ============================================

model Ticket {
  id           String         @id @default(cuid())
  ticketNumber Int            @unique @default(autoincrement())
  ticketRef    String?        @unique // Format: 26-0001 (année-numéro séquentiel)
  title        String
  description  String?
  status       TicketStatus   @default(OPEN)
  priority     TicketPriority @default(MEDIUM)
  issueType    IssueType      @default(OTHER)

  // SLA
  slaDeadline  DateTime?
  slaBreached  Boolean @default(false)

  // Tags
  tags String[] @default([])

  // Customer
  customerId String?
  customer   User? @relation("CustomerTickets", fields: [customerId], references: [id], onDelete: SetNull)

  // Contact info (pour tickets créés manuellement sans compte client)
  contactName  String?
  contactEmail String?
  contactPhone String?
  companyName  String?

  // Informations équipement (pour problèmes techniques)
  serialNumber      String?   // Numéro de série
  equipmentModel    String?   // Modèle de l'équipement
  equipmentBrand    String?   // Marque
  errorCode         String?   // Code d'erreur affiché

  // Agent assigne
  assignedToId String?
  assignedTo   User? @relation("AssignedTickets", fields: [assignedToId], references: [id], onDelete: SetNull)

  // Commande liee
  orderId String?
  order   Order? @relation(fields: [orderId], references: [id], onDelete: SetNull)

  // Relations
  messages    ChatMessage[]
  attachments Attachment[]
  history     TicketHistory[]
  cannedResponsesUsed CannedResponseUse[]

  // Satisfaction
  satisfactionScore Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([assignedToId])
  @@index([assignedToId, status])
  @@index([status, priority])
  @@index([slaDeadline])
  @@index([createdAt])
  @@index([ticketRef])
}

// ============================================
// MODEL: CHAT MESSAGE
// ============================================

model ChatMessage {
  id        String   @id @default(cuid())
  ticketId  String
  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  authorId  String
  author    User     @relation(fields: [authorId], references: [id], onDelete: Restrict)

  content   String
  isInternal Boolean @default(false) // Note interne (invisible pour le client)
  readBy    Json?

  createdAt DateTime @default(now())

  // Mentions @user
  mentions  User[]   @relation("MessageMentions")

  // Pieces jointes
  attachments Attachment[]

  @@index([ticketId])
  @@index([ticketId, createdAt])
  @@index([authorId])
}

// ============================================
// MODEL: ATTACHMENT
// ============================================

model Attachment {
  id        String            @id @default(cuid())
  context   AttachmentContext

  url       String
  fileName  String
  mimeType  String
  sizeBytes Int

  ticketId  String?
  ticket    Ticket?     @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  messageId String?
  message   ChatMessage? @relation(fields: [messageId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([ticketId])
  @@index([messageId])
  @@index([context, ticketId])
  @@index([context, messageId])
}

// ============================================
// MODEL: TICKET HISTORY
// ============================================

model TicketHistory {
  id        String       @id @default(cuid())
  ticketId  String
  ticket    Ticket       @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  actorId   String?
  actor     User?        @relation("HistoryActor", fields: [actorId], references: [id], onDelete: SetNull)

  action    TicketAction
  field     String?
  oldValue  String?
  newValue  String?
  metadata  Json?

  createdAt DateTime @default(now())

  @@index([ticketId])
  @@index([ticketId, createdAt])
  @@index([actorId])
  @@index([actorId, createdAt])
}

// ============================================
// MODEL: SLA CONFIG
// ============================================

model SlaConfig {
  id                 String         @id @default(cuid())
  priority           TicketPriority
  issueType          IssueType?

  firstResponseTime  Int // minutes
  resolutionTime     Int // minutes

  @@unique([priority, issueType])
}

// ============================================
// MODEL: NOTIFICATION
// ============================================

model Notification {
  id        String           @id @default(cuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  type      NotificationType
  ticketId  String?
  messageId String?
  payload   Json?

  isRead    Boolean @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([userId, isRead])
  @@index([createdAt])
}

// ============================================
// MODEL: CANNED RESPONSE
// ============================================

model CannedResponse {
  id        String   @id @default(cuid())
  title     String
  content   String
  tags      String[] @default([])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relation usage
  uses CannedResponseUse[]

  @@index([tags])
}

// ============================================
// MODEL: CANNED RESPONSE USE
// ============================================

model CannedResponseUse {
  id               String   @id @default(cuid())
  ticketId         String
  ticket           Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  cannedResponseId String
  cannedResponse   CannedResponse @relation(fields: [cannedResponseId], references: [id], onDelete: Cascade)

  usedById         String?
  usedBy           User?   @relation(fields: [usedById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([ticketId])
  @@index([ticketId, createdAt])
  @@index([cannedResponseId])
}

// ============================================
// MODEL: AUTOMATION RULE
// ============================================

enum AutomationTrigger {
  TICKET_CREATED
  TICKET_UPDATED
  TICKET_STATUS_CHANGED
  TICKET_RESOLVED
  TICKET_CLOSED
  TICKET_IDLE_4H
  TICKET_WAITING_3DAYS
  TICKET_RESOLVED_7DAYS
  SLA_WARNING
  SLA_BREACH
}

model AutomationRule {
  id          String             @id @default(cuid())
  name        String
  description String?
  trigger     AutomationTrigger
  conditions  Json               @default("[]")  // Array of condition objects
  actions     Json               @default("[]")  // Array of action objects
  isActive    Boolean            @default(true)
  priority    Int                @default(0)     // For execution order

  createdById String?
  createdBy   User?              @relation("AutomationCreator", fields: [createdById], references: [id], onDelete: SetNull)

  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  // Execution logs
  executions  AutomationExecution[]

  @@index([isActive])
  @@index([trigger])
  @@index([createdAt])
}

// ============================================
// MODEL: AUTOMATION EXECUTION
// ============================================

model AutomationExecution {
  id        String          @id @default(cuid())
  ruleId    String
  rule      AutomationRule  @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  ticketId  String?
  success   Boolean         @default(true)
  error     String?
  details   Json?           // Additional execution details

  executedAt DateTime       @default(now())

  @@index([ruleId])
  @@index([ticketId])
  @@index([executedAt])
  @@index([ruleId, executedAt])
}

// ============================================
// MODEL: BRAND (Marques pour fiches techniques)
// ============================================

model Brand {
  id          String   @id @default(cuid())
  name        String   @unique  // Nom de la marque (ex: Bosch, Siemens)
  slug        String   @unique  // URL-friendly (ex: bosch, siemens)
  description String?           // Description optionnelle
  logoUrl     String?           // URL du logo de la marque
  folderUrl   String?           // Lien vers le dossier SharePoint/Drive
  websiteUrl  String?           // Site web officiel de la marque
  order       Int      @default(0)
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@index([order])
}
